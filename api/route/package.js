const express = require('express');
const router = express.Router();
const multer = require('multer');
const path = require('path');
const database = require('../database');
const authenticateToken = require('../middlewares/authenticateToken');
const getRole = require('../middlewares/getRole');
const { sendEmail } = require('../email/emailService');

const storage = multer.diskStorage({
  destination: function (req, file, cb) {
    cb(null, 'packages');
  },
  filename: function (req, file, cb) {
    const uniqueName = Date.now() + path.extname(file.originalname);
    cb(null, uniqueName);
  },
});

const upload = multer({ storage });

function getThaiTimeString() {
  const thaiTime = new Date().toLocaleString('sv-SE', {
    timeZone: 'Asia/Bangkok',
    hour12: false
  });
  return thaiTime.replace(' ', 'T');
}

function formatThaiDateTime(isoString) {
  const date = new Date(isoString);

  // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
  const thaiDate = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }));

  const day = thaiDate.getDate();
  const month = thaiDate.getMonth(); // 0-indexed
  const year = thaiDate.getFullYear() + 543;
  const hours = thaiDate.getHours().toString().padStart(2, '0');
  const minutes = thaiDate.getMinutes().toString().padStart(2, '0');

  const thaiMonths = [
    '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
    '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'
  ];

  return `${day} ${thaiMonths[month]} ${year} ${hours}:${minutes} ‡∏ô.`;
}

router.post('/add', authenticateToken, upload.single('image'), async (req, res) => {
  const {
    recipientRoomNo,
    recipientName,
    recipientID,
    trackingNo,
    dormID
  } = req.body;

  const userID = req.user.id;

  try {
    const userRole = await getRole(userID, dormID);
    if (!userRole || !['owner', 'manager'].includes(userRole.role)) {
      return res.status(403).json({ message: 'Permission denied' });
    }

    const pathToPicture = req.file ? `/packages/${req.file.filename}` : '';
    const registerTime = getThaiTimeString();

    // Insert package
    const insertQuery = `
      INSERT INTO package (
        recipientName,
        recipientRoomNo,
        recipientID,
        trackingNo,
        pathToPicture,
        status,
        registerBy,
        registerTime,
        deliverBy,
        deliverTime,
        receiver,
        dormID
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;
    const values = [
      recipientName,
      recipientRoomNo,
      recipientID,
      trackingNo,
      pathToPicture,
      'wait_for_deliver',
      userRole.fullName,
      registerTime,
      '', null, '', dormID
    ];

    database.query(insertQuery, values, async (err, result) => {
      if (err) {
        console.error('Error inserting package:', err);
        return res.status(500).json({ message: 'Database error' });
      }

      try {
        // ‡∏î‡∏∂‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö
        const [userRow] = await new Promise((resolve, reject) => {
          database.query(`SELECT email FROM user WHERE id = ? LIMIT 1`, [recipientID], (err, results) => {
            if (err) return reject(err);
            resolve(results);
          });
        });

        if (!userRow?.email) {
          console.log('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö');
          return res.json({ message: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•)' });
        }

        // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏û‡∏±‡∏Å
        const [dormRow] = await new Promise((resolve, reject) => {
          database.query(`SELECT name FROM dormitory WHERE id = ? LIMIT 1`, [dormID], (err, results) => {
            if (err) return reject(err);
            resolve(results);
          });
        });

        const dormName = dormRow?.name || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏û‡∏±‡∏Å';

        // ‡∏ô‡∏±‡∏ö‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏£‡∏±‡∏ö
        const [countRow] = await new Promise((resolve, reject) => {
          database.query(`
            SELECT COUNT(*) AS count
            FROM package
            WHERE recipientID = ? AND dormID = ? AND status = 'wait_for_deliver'
          `, [recipientID, dormID], (err, results) => {
            if (err) return reject(err);
            resolve(results);
          });
        });

        const count = countRow?.count || 0;

        const thaiTime = formatThaiDateTime(registerTime);

        // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•
        const mailOptions = {
          from: `"Dormitory Admin" <test@gmail.com>`,
          to: userRow.email,
          subject: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
          html: `
            <p>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì <strong>${recipientName}</strong>,</p>
            <p>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà <strong>${userRole.fullName}</strong> ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏•‡∏á‡πÉ‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å <strong>${dormName}</strong>:</p>
            <ul>
              <li><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏:</strong> ${trackingNo}</li>
              <li><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:</strong> ${recipientName}</li>
              <li><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á:</strong> ${recipientRoomNo}</li>
              <li><strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${thaiTime}</li>
            </ul>
            <p>‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏û‡∏±‡∏™‡∏î‡∏∏‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>${count} ‡∏ä‡∏¥‡πâ‡∏ô ‡πÉ‡∏ô‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ô‡∏µ‡πâ </strong></p>
          `
        };

        await sendEmail(mailOptions);
        console.log(`üìß Email sent to ${userRow.email}`);

        res.json({
          message: 'Package added and email sent',
          addedBy: userRole.fullName,
          role: userRole.role
        });

      } catch (emailErr) {
        console.error('Error sending email:', emailErr);
        res.json({
          message: 'Package added, but failed to send email',
          error: emailErr.message
        });
      }
    });

  } catch (err) {
    console.error('Unexpected error:', err);
    res.status(500).json({ message: 'Internal server error' });
  }
});

//FOR manager
router.post('/getByDormAndStatus', (req, res) => {
  const { dormID, status, search, limit = 10, offset = 0, date } = req.body;
  const searchText = `%${search || ''}%`;

  let query = `
    SELECT * FROM package
    WHERE dormID = ? AND status = ?
    AND (
      recipientName LIKE ? OR
      recipientRoomNo LIKE ? OR
      trackingNo LIKE ?
    )
  `;
  const params = [dormID, status, searchText, searchText, searchText];

  const timeField = status === 'delivered' ? 'deliverTime' : 'registerTime';

  if (date) {
    query += ` AND DATE(${timeField}) = ?`;
    params.push(date); // 'YYYY-MM-DD'
  }

  query += ` ORDER BY ${timeField} DESC LIMIT ? OFFSET ?`;
  params.push(parseInt(limit), parseInt(offset));

  database.query(query, params, (err, results) => {
    if (err) {
      console.error('Database error:', err);
      return res.status(500).json({ message: 'Database error' });
    }
    res.json(results);
  });
});

// ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏±‡∏™‡∏î‡∏∏
router.post('/getByDormAndStatus/count', (req, res) => {
  const { dormID, status, search, date } = req.body;
  const searchText = `%${search || ''}%`;

  const timeField = status === 'delivered' ? 'deliverTime' : 'registerTime';

  let query = `
    SELECT COUNT(*) AS total FROM package
    WHERE dormID = ? AND status = ?
    AND (
      recipientName LIKE ? OR
      recipientRoomNo LIKE ? OR
      trackingNo LIKE ?
    )
  `;
  const params = [dormID, status, searchText, searchText, searchText];

  if (date) {
    query += ` AND DATE(${timeField}) = ?`;
    params.push(date);
  }

  database.query(query, params, (err, results) => {
    if (err) {
      console.error('Database error:', err);
      return res.status(500).json({ message: 'Database error' });
    }
    res.json(results[0]); // { total: ... }
  });
});





//FOR tenant
router.post('/getByDormAndStatusAndUserID', (req, res) => {
  const { dormID, status, userID } = req.body;

  const query = `
      SELECT * FROM package
      WHERE dormID = ? AND status = ? AND recipientID = ?
    `;
  database.query(query, [dormID, status, userID], (err, results) => {
    if (err) {
      console.error('Database error:', err);
      return res.status(500).json({ message: 'Database error' });
    }
    res.json(results);
  });
});

router.post('/getByUserID', authenticateToken, (req, res) => {
  const userID = req.user.id;
  const query = `
        SELECT package.*, dorm.name AS dormName
        FROM package
        LEFT JOIN dormitory dorm ON package.dormID = dorm.id
        WHERE recipientID = ?
        ORDER BY dormName
    `;
  database.query(query, [userID], (err, results) => {
    if (err) return res.status(500).json({ message: 'Database error' });
    res.json(results);
  });
});

router.post('/getByID', (req, res) => {
  const { id } = req.body;
  const query = `
        SELECT * FROM package WHERE id = ?
    `;
  database.query(query, [id], (err, results) => {
    if (err) return res.status(500).json({ message: 'Database error' });
    res.json(results[0]);

  });
});

// UPDATE
const fs = require('fs');

router.post('/update', upload.single('image'), async (req, res) => {
  const {
    id,
    recipientID,
    recipientName,
    recipientRoomNo,
    trackingNo,
    oldPath,
    deleteImage,
  } = req.body;

  try {
    let pathToPicture = oldPath;

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
    if (req.file) {
      pathToPicture = `/packages/${req.file.filename}`;

      // ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà default)
      if (oldPath) {
        const oldFilePath = path.join(__dirname, '..', oldPath);
        fs.unlink(oldFilePath, (err) => {
          if (err) console.error('Error deleting image:', err);
        });
      }
    } else {
      if (deleteImage === 'true') {
        console.log(oldPath)
        console.log("DELETE OLD IMAGE PATH")
        pathToPicture = ''; //‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ set ‡∏•‡∏á db
        const oldFilePath = path.join(__dirname, '..', oldPath);
        fs.unlink(oldFilePath, (err) => {
          if (err) console.error('Error deleting image:', err);
        });
      }
    }

    database.query(`
      UPDATE package SET
        recipientID = ?,
        recipientName = ?,
        recipientRoomNo = ?,
        trackingNo = ?,
        pathToPicture = ?
      WHERE id = ?
    `, [recipientID, recipientName, recipientRoomNo, trackingNo, pathToPicture, id]);

    res.json({ message: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' });
  } catch (err) {
    console.error('Update package error:', err);
    res.status(500).json({ error: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏±‡∏™‡∏î‡∏∏‡πÑ‡∏î‡πâ' });
  }
});



router.post('/checkIfExist', (req, res) => {
  const { trackingNo } = req.body;
  if (!trackingNo) {
    return res.status(400).json({ message: 'trackingNo is required' });
  }

  const query = `
    SELECT * FROM package
    WHERE trackingNo = ? AND status = 'wait_for_deliver'
  `;

  database.query(query, [trackingNo], (err, results) => {
    if (err) {
      console.error('Database error:', err);
      return res.status(500).json({ message: 'Database error' });
    }
    console.log(results)
    res.json(results);
  });
});




module.exports = router;
